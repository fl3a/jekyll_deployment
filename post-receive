#!/bin/bash

# Deployment of Jekyll-Sites via Git Bare Repository and post-receive hook.
#
# USAGE:
# - git hook: Place this script as .hooks/post-receive within your git repository
# - standalone: ${SCRIPT} /path/to/git-bare-repository
#
# See https://florian.latzel.io/jekyll-deployment-via-bare-repository-und-post-receive-hook.html
# for setup and a more detailed description (german)
#
set -x

if [ -z "$1" ]; then
  read oldrev newrev ref 
  pushed_branch=${ref#refs/heads/} 
elif [ -d "$1" ] && { cd $1 ; git rev-parse --is-bare-repository ; } >/dev/null; then
  pushed_branch=""
else
  exit
fi

config=$(mktemp)
git show HEAD:deploy.conf > $config || exit 
source $config

[ -z "$pushed_branch" ] && pushed_branch=$build_branch
[ "$pushed_branch" != "$build_branch" ] && exit 
tmp=$(mktemp -d)
git clone --single-branch --branch $build_branch $git_repo $tmp
cd $tmp
bundle install || bundle install --redownload
JEKYLL_ENV=${env:-production} \
  bundle exec jekyll build --source $tmp --destination $www $build_prefix
rm -rf $tmp $config
