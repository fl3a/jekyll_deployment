#!/bin/bash

# Deployment of Jekyll-Sites via Git Bare Repository and post-receive hook.
#
# USAGE:
# - git hook: Place this script as .hooks/post-receive within your git repository
# - standalone: ${SCRIPT} /path/to/git-bare-repository
#
# See https://florian.latzel.io/jekyll-deployment-via-bare-repository-und-post-receive-hook.html
# for setup and a more detailed description (german)
#
# set -x

## Get pushed branch when called via git hook
if [ -z "$1" ]; then
  read oldrev newrev ref 
  pushed_branch=${ref#refs/heads/} 
else 
## Script is called directly with supplied bare repository argument
  [ -d "$1" ] && { cd $1 ; git rev-parse --is-bare-repository ; } &> /dev/null || exit 
  pushed_branch=""
fi

## Get configuration file from bare repository and source it
config=$(mktemp)
git show HEAD:deploy.conf > $config || exit 
source $config

[ -z "$pushed_branch" ] && build_branch=$pushed_branch
[ "$pushed_branch" != "$build_branch" ] && exit 
tmp=$(mktemp -d)
git clone $git_repo $tmp
cd $tmp
bundle install || bundle install --redownload
JEKYLL_ENV=${env:-production} \
  bundle exec jekyll build --source $tmp --destination $www $build_prefix
rm -rf $tmp $config
